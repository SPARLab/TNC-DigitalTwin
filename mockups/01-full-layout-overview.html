<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mockup 1: Full Layout Overview - TNC Digital Catalog</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- ArcGIS JS API -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.28/"></script>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'inter': ['Inter', 'sans-serif'],
          },
          colors: {
            'tnc-green': '#2e7d32',
            'tnc-green-dark': '#1b5e20',
            'sidebar-bg': '#f8fafc',
            'pinned-bg': '#dbeafe',
            'visible-bg': '#fef3c7',
            'selected-border': '#059669',
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    
    .esri-ui-corner { display: none !important; }
    
    .sidebar-scroll::-webkit-scrollbar { width: 6px; }
    .sidebar-scroll::-webkit-scrollbar-track { background: transparent; }
    .sidebar-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .sidebar-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    .icon-btn { transition: all 0.15s ease; }
    .icon-btn:hover { transform: scale(1.15); }
    
    /* Layer row states */
    .layer-row { transition: all 0.15s ease; }
    .layer-row:hover { background-color: #f1f5f9; }
    .layer-row.pinned { background-color: #dbeafe; }
    .layer-row.visible-only { background-color: #fef3c7; }
    .layer-row.selected { border-left: 3px solid #059669; }
    
    .floating-widget { box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.15); }
    
    .tab-btn { transition: all 0.15s ease; }
    .tab-btn.active { border-bottom: 2px solid #059669; color: #059669; font-weight: 500; }
    .tab-btn:not(.active):hover { background-color: #f1f5f9; }
    
    .chevron { transition: transform 0.2s ease; }
    .chevron.expanded { transform: rotate(90deg); }
    
    .spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    
    /* Clickable highlight */
    .clickable-layer { 
      border: 1px solid transparent;
      transition: all 0.15s ease;
    }
    .clickable-layer:hover {
      border-color: #3b82f6;
      background-color: #eff6ff;
    }
  </style>
</head>
<body class="bg-slate-100 h-screen overflow-hidden">
  
  <!-- HEADER -->
  <header id="header" class="h-12 bg-white border-b border-slate-200 flex items-center px-4 shadow-sm">
    <div class="flex items-center gap-3">
      <div class="w-8 h-8 bg-tnc-green rounded flex items-center justify-center">
        <span class="text-white font-bold text-sm">TNC</span>
      </div>
      <h1 class="text-base font-semibold text-slate-800">Dangermond Preserve Data Catalog</h1>
    </div>
    <div class="ml-auto flex items-center gap-4">
      <span class="text-xs text-slate-500">MOCKUP: Layer Browser with Pin/Visibility UX</span>
    </div>
  </header>
  
  <!-- MAIN LAYOUT -->
  <div id="main-layout" class="flex h-[calc(100vh-48px)]">
    
    <!-- LEFT SIDEBAR: Layer Browser -->
    <aside id="left-sidebar" class="w-80 bg-sidebar-bg border-r border-slate-200 flex flex-col">
      
      <!-- Search Bar -->
      <div class="p-3 border-b border-slate-200">
        <div class="relative">
          <input type="text" placeholder="Search layers..." 
            class="w-full pl-9 pr-20 py-2 text-sm border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-tnc-green focus:border-transparent">
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <button class="absolute right-2 top-1/2 -translate-y-1/2 text-xs text-blue-600 hover:text-blue-800 font-medium">Advanced</button>
        </div>
      </div>
      
      <!-- Legend for icons -->
      <div class="px-3 py-2 bg-slate-100 border-b border-slate-200 flex items-center gap-4 text-xs text-slate-500">
        <span class="flex items-center gap-1">
          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
          </svg>
          = visible
        </span>
        <span class="flex items-center gap-1">üìå = pinned</span>
      </div>
      
      <!-- Layer List -->
      <div id="layer-list" class="flex-1 overflow-y-auto sidebar-scroll p-2">
        
        <!-- SOILS & GEOLOGY -->
        <div class="category mb-1" data-category="geology">
          <button class="category-header w-full flex items-center gap-2 px-2 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-100 rounded" onclick="toggleCategory('geology')">
            <svg class="chevron w-4 h-4 text-slate-400 expanded" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            <span>ü™®</span>
            <span>Soils & Geology</span>
            <span class="ml-auto text-xs text-slate-400 font-normal">4 layers</span>
          </button>
          <div class="category-content ml-4 space-y-0.5">
            
            <!-- Earthquake Faults - PINNED -->
            <div class="layer-row clickable-layer pinned selected flex items-center gap-2 px-2 py-1.5 rounded cursor-pointer" 
                 data-layer="earthquake-faults" data-has-map="true" onclick="selectLayer('earthquake-faults')">
              <button class="icon-btn flex-shrink-0" onclick="event.stopPropagation(); toggleVisibility('earthquake-faults')" title="Toggle visibility">
                <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                </svg>
              </button>
              <span class="flex-1 text-sm text-slate-700 truncate">Earthquake Faults</span>
              <button class="icon-btn flex-shrink-0 opacity-100" onclick="event.stopPropagation(); togglePin('earthquake-faults')" title="Pinned - click to unpin">
                <span class="text-sm">üìå</span>
              </button>
            </div>
            
            <!-- Soil Types - not pinned, not visible -->
            <div class="layer-row clickable-layer flex items-center gap-2 px-2 py-1.5 rounded cursor-pointer" 
                 data-layer="soil-types" data-has-map="true" onclick="selectLayer('soil-types')">
              <button class="icon-btn flex-shrink-0" onclick="event.stopPropagation(); toggleVisibility('soil-types')" title="Click to show on map">
                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
              </button>
              <span class="flex-1 text-sm text-slate-700 truncate">Soil Types</span>
              <button class="icon-btn flex-shrink-0 opacity-30 hover:opacity-100" onclick="event.stopPropagation(); togglePin('soil-types')" title="Click to pin">
                <span class="text-sm">üìå</span>
              </button>
            </div>
            
            <!-- Geologic Units -->
            <div class="layer-row clickable-layer flex items-center gap-2 px-2 py-1.5 rounded cursor-pointer" 
                 data-layer="geologic-units" data-has-map="true" onclick="selectLayer('geologic-units')">
              <button class="icon-btn flex-shrink-0" onclick="event.stopPropagation(); toggleVisibility('geologic-units')" title="Click to show on map">
                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
              </button>
              <span class="flex-1 text-sm text-slate-700 truncate">Geologic Units</span>
              <button class="icon-btn flex-shrink-0 opacity-30 hover:opacity-100" onclick="event.stopPropagation(); togglePin('geologic-units')" title="Click to pin">
                <span class="text-sm">üìå</span>
              </button>
            </div>
          </div>
        </div>
        
        <!-- SPECIES -->
        <div class="category mb-1" data-category="species">
          <button class="category-header w-full flex items-center gap-2 px-2 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-100 rounded" onclick="toggleCategory('species')">
            <svg class="chevron w-4 h-4 text-slate-400 expanded" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            <span>ü¶é</span>
            <span>Species</span>
            <span class="ml-auto text-xs text-slate-400 font-normal">6 layers</span>
          </button>
          <div class="category-content ml-4 space-y-0.5">
            
            <!-- iNaturalist - PINNED -->
            <div class="layer-row clickable-layer pinned flex items-center gap-2 px-2 py-1.5 rounded cursor-pointer" 
                 data-layer="inaturalist" data-has-map="true" onclick="selectLayer('inaturalist')">
              <button class="icon-btn flex-shrink-0" onclick="event.stopPropagation(); toggleVisibility('inaturalist')" title="Toggle visibility">
                <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                </svg>
              </button>
              <span class="flex-1 text-sm text-slate-700 truncate">iNaturalist Observations</span>
              <button class="icon-btn flex-shrink-0" onclick="event.stopPropagation(); togglePin('inaturalist')" title="Pinned - click to unpin">
                <span class="text-sm">üìå</span>
              </button>
            </div>
            
            <!-- eBird -->
            <div class="layer-row clickable-layer flex items-center gap-2 px-2 py-1.5 rounded cursor-pointer" 
                 data-layer="ebird" data-has-map="true" onclick="selectLayer('ebird')">
              <button class="icon-btn flex-shrink-0" onclick="event.stopPropagation(); toggleVisibility('ebird')" title="Click to show on map">
                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
              </button>
              <span class="flex-1 text-sm text-slate-700 truncate">eBird Sightings</span>
              <button class="icon-btn flex-shrink-0 opacity-30 hover:opacity-100" onclick="event.stopPropagation(); togglePin('ebird')" title="Click to pin">
                <span class="text-sm">üìå</span>
              </button>
            </div>
            
            <!-- CalFlora -->
            <div class="layer-row clickable-layer flex items-center gap-2 px-2 py-1.5 rounded cursor-pointer" 
                 data-layer="calflora" data-has-map="true" onclick="selectLayer('calflora')">
              <button class="icon-btn flex-shrink-0" onclick="event.stopPropagation(); toggleVisibility('calflora')" title="Click to show on map">
                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
              </button>
              <span class="flex-1 text-sm text-slate-700 truncate">CalFlora Plants</span>
              <button class="icon-btn flex-shrink-0 opacity-30 hover:opacity-100" onclick="event.stopPropagation(); togglePin('calflora')" title="Click to pin">
                <span class="text-sm">üìå</span>
              </button>
            </div>
          </div>
        </div>
        
        <!-- FIRE -->
        <div class="category mb-1" data-category="fire">
          <button class="category-header w-full flex items-center gap-2 px-2 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-100 rounded" onclick="toggleCategory('fire')">
            <svg class="chevron w-4 h-4 text-slate-400 expanded" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            <span>üî•</span>
            <span>Fire</span>
            <span class="ml-auto text-xs text-slate-400 font-normal">5 layers</span>
          </button>
          <div class="category-content ml-4 space-y-0.5">
            
            <!-- Fire Hazard - PINNED -->
            <div class="layer-row clickable-layer pinned flex items-center gap-2 px-2 py-1.5 rounded cursor-pointer" 
                 data-layer="fire-hazard" data-has-map="true" onclick="selectLayer('fire-hazard')">
              <button class="icon-btn flex-shrink-0" onclick="event.stopPropagation(); toggleVisibility('fire-hazard')" title="Toggle visibility">
                <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                </svg>
              </button>
              <span class="flex-1 text-sm text-slate-700 truncate">Fire Hazard Severity Zones</span>
              <button class="icon-btn flex-shrink-0" onclick="event.stopPropagation(); togglePin('fire-hazard')" title="Pinned - click to unpin">
                <span class="text-sm">üìå</span>
              </button>
            </div>
            
            <!-- Fire Threat -->
            <div class="layer-row clickable-layer flex items-center gap-2 px-2 py-1.5 rounded cursor-pointer" 
                 data-layer="fire-threat" data-has-map="true" onclick="selectLayer('fire-threat')">
              <button class="icon-btn flex-shrink-0" onclick="event.stopPropagation(); toggleVisibility('fire-threat')" title="Click to show on map">
                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
              </button>
              <span class="flex-1 text-sm text-slate-700 truncate">Fire Threat Assessment</span>
              <button class="icon-btn flex-shrink-0 opacity-30 hover:opacity-100" onclick="event.stopPropagation(); togglePin('fire-threat')" title="Click to pin">
                <span class="text-sm">üìå</span>
              </button>
            </div>
            
            <!-- Historic Perimeters -->
            <div class="layer-row clickable-layer flex items-center gap-2 px-2 py-1.5 rounded cursor-pointer" 
                 data-layer="fire-perimeters" data-has-map="true" onclick="selectLayer('fire-perimeters')">
              <button class="icon-btn flex-shrink-0" onclick="event.stopPropagation(); toggleVisibility('fire-perimeters')" title="Click to show on map">
                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
              </button>
              <span class="flex-1 text-sm text-slate-700 truncate">Historic Fire Perimeters</span>
              <button class="icon-btn flex-shrink-0 opacity-30 hover:opacity-100" onclick="event.stopPropagation(); togglePin('fire-perimeters')" title="Click to pin">
                <span class="text-sm">üìå</span>
              </button>
            </div>
          </div>
        </div>
        
        <!-- BOUNDARIES (collapsed) -->
        <div class="category mb-1" data-category="boundaries">
          <button class="category-header w-full flex items-center gap-2 px-2 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-100 rounded" onclick="toggleCategory('boundaries')">
            <svg class="chevron w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            <span>üåê</span>
            <span>Boundaries</span>
            <span class="ml-auto text-xs text-slate-400 font-normal">3 layers</span>
          </button>
          <div class="category-content hidden ml-4"></div>
        </div>
        
        <!-- FRESHWATER (collapsed) -->
        <div class="category mb-1" data-category="freshwater">
          <button class="category-header w-full flex items-center gap-2 px-2 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-100 rounded" onclick="toggleCategory('freshwater')">
            <svg class="chevron w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            <span>üíß</span>
            <span>Freshwater</span>
            <span class="ml-auto text-xs text-slate-400 font-normal">4 layers</span>
          </button>
          <div class="category-content hidden ml-4"></div>
        </div>
        
      </div>
    </aside>
    
    <!-- MAP AREA -->
    <main id="map-area" class="flex-1 relative">
      
      <!-- ArcGIS Map Container -->
      <div id="viewDiv" class="absolute inset-0"></div>
      
      <!-- Loading Overlay -->
      <div id="loading-overlay" class="absolute inset-0 bg-slate-200/80 flex items-center justify-center z-10">
        <div class="text-center">
          <svg class="spinner w-10 h-10 text-tnc-green mx-auto mb-3" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <p class="text-slate-600 font-medium">Loading map layers...</p>
        </div>
      </div>
      
      <!-- FLOATING LAYERS WIDGET -->
      <div id="floating-widget" class="floating-widget absolute top-4 left-4 bg-white rounded-lg border border-slate-200 w-72 z-20">
        
        <!-- Widget Header -->
        <div class="flex items-center justify-between px-3 py-2 border-b border-slate-100 cursor-pointer bg-slate-50 rounded-t-lg" onclick="toggleFloatingWidget()">
          <div class="flex items-center gap-2">
            <span class="text-sm">üó∫Ô∏è</span>
            <span class="text-sm font-semibold text-slate-700">Map Layers</span>
          </div>
          <svg id="widget-chevron" class="w-4 h-4 text-slate-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </div>
        
        <!-- Widget Content -->
        <div id="widget-content">
          
          <!-- VISIBLE LAYER SECTION (one non-pinned layer) -->
          <div id="visible-section" class="hidden">
            <div class="px-3 py-1.5 bg-amber-50 border-b border-amber-200">
              <span class="text-xs font-semibold text-amber-700 uppercase tracking-wide">üëÅÔ∏è Visible Layer</span>
            </div>
            <div id="visible-layer-slot" class="p-2">
              <!-- Dynamically populated -->
            </div>
          </div>
          
          <!-- PINNED LAYERS SECTION -->
          <div id="pinned-section">
            <div class="px-3 py-1.5 bg-blue-50 border-b border-blue-200">
              <span class="text-xs font-semibold text-blue-700 uppercase tracking-wide flex items-center gap-1">
                üìå Pinned Layers
                <span id="pinned-count" class="bg-blue-200 text-blue-800 px-1.5 rounded-full text-xs">3</span>
              </span>
            </div>
            <div id="pinned-layers-list" class="p-2 space-y-1">
              
              <!-- Earthquake Faults -->
              <div class="widget-layer flex items-center gap-2 px-2 py-1.5 rounded hover:bg-slate-50" data-widget-layer="earthquake-faults">
                <button class="icon-btn flex-shrink-0" onclick="toggleMapLayerVisibility('earthquake-faults')" title="Toggle visibility">
                  <span class="text-sm">üëÅÔ∏è</span>
                </button>
                <div class="flex items-center gap-2 flex-1 min-w-0">
                  <span class="w-3 h-0.5 bg-purple-500 flex-shrink-0"></span>
                  <span class="text-sm text-slate-700 truncate">Earthquake Faults</span>
                </div>
                <button class="icon-btn text-slate-400 hover:text-red-500 flex-shrink-0" onclick="unpinLayer('earthquake-faults')" title="Remove from pinned">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                </button>
              </div>
              
              <!-- iNaturalist -->
              <div class="widget-layer flex items-center gap-2 px-2 py-1.5 rounded hover:bg-slate-50" data-widget-layer="inaturalist">
                <button class="icon-btn flex-shrink-0" onclick="toggleMapLayerVisibility('inaturalist')" title="Toggle visibility">
                  <span class="text-sm">üëÅÔ∏è</span>
                </button>
                <div class="flex items-center gap-2 flex-1 min-w-0">
                  <span class="w-3 h-3 rounded-full bg-green-500 flex-shrink-0"></span>
                  <span class="text-sm text-slate-700 truncate">iNaturalist Observations</span>
                </div>
                <button class="icon-btn text-slate-400 hover:text-red-500 flex-shrink-0" onclick="unpinLayer('inaturalist')" title="Remove from pinned">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                </button>
              </div>
              
              <!-- Fire Hazard -->
              <div class="widget-layer flex items-center gap-2 px-2 py-1.5 rounded hover:bg-slate-50" data-widget-layer="fire-hazard">
                <button class="icon-btn flex-shrink-0" onclick="toggleMapLayerVisibility('fire-hazard')" title="Toggle visibility">
                  <span class="text-sm">üëÅÔ∏è</span>
                </button>
                <div class="flex items-center gap-2 flex-1 min-w-0">
                  <span class="w-3 h-3 rounded-sm bg-orange-500 flex-shrink-0"></span>
                  <span class="text-sm text-slate-700 truncate">Fire Hazard Severity Zones</span>
                </div>
                <button class="icon-btn text-slate-400 hover:text-red-500 flex-shrink-0" onclick="unpinLayer('fire-hazard')" title="Remove from pinned">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                </button>
              </div>
              
            </div>
          </div>
          
          <!-- Tip -->
          <div class="px-3 py-2 bg-slate-50 border-t border-slate-100 rounded-b-lg">
            <p class="text-xs text-slate-500">üí° Pin layers to keep them on the map. Only one non-pinned layer can be visible at a time.</p>
          </div>
        </div>
      </div>
      
    </main>
    
    <!-- RIGHT SIDEBAR -->
    <aside id="right-sidebar" class="w-80 bg-white border-l border-slate-200 flex flex-col">
      
      <div class="px-4 py-3 border-b border-slate-200">
        <div class="flex items-center gap-2">
          <span class="w-3 h-0.5 bg-purple-500"></span>
          <h2 class="text-sm font-semibold text-slate-800">Earthquake Faults</h2>
        </div>
        <p class="text-xs text-slate-500 mt-1">Known fault lines in the region</p>
      </div>
      
      <div id="tabs" class="flex border-b border-slate-200">
        <button class="tab-btn active flex-1 px-4 py-2 text-sm text-slate-600" data-tab="overview" onclick="switchTab('overview')">Overview</button>
        <button class="tab-btn flex-1 px-4 py-2 text-sm text-slate-600" data-tab="browse" onclick="switchTab('browse')">Browse</button>
        <button class="tab-btn flex-1 px-4 py-2 text-sm text-slate-600" data-tab="export" onclick="switchTab('export')">Export</button>
      </div>
      
      <div id="tab-content" class="flex-1 overflow-y-auto sidebar-scroll">
        
        <div id="tab-overview" class="tab-panel p-4">
          <div class="space-y-4">
            <div>
              <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Description</h3>
              <p class="text-sm text-slate-700">Known earthquake faults across the USA from USGS data.</p>
            </div>
            
            <div class="bg-amber-50 rounded-lg p-3 border border-amber-200">
              <p class="text-sm font-medium text-amber-800">üéØ UX Demo</p>
              <p class="text-xs text-amber-700 mt-1">
                Try clicking the üëÅÔ∏è icon on an <strong>unpinned</strong> layer (like "Soil Types") in the left sidebar. 
                It will appear in the "Visible Layer" section of the floating widget!
              </p>
            </div>
            
            <div>
              <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Layer Legend</h3>
              <div class="space-y-2">
                <div class="flex items-center gap-2 p-2 bg-slate-50 rounded">
                  <span class="w-4 h-0.5 bg-purple-500"></span>
                  <span class="text-sm text-slate-700">Fault lines</span>
                </div>
                <div class="flex items-center gap-2 p-2 bg-slate-50 rounded">
                  <span class="w-3 h-3 rounded-full bg-green-500"></span>
                  <span class="text-sm text-slate-700">iNaturalist points</span>
                </div>
                <div class="flex items-center gap-2 p-2 bg-slate-50 rounded">
                  <span class="w-3 h-3 rounded-sm bg-orange-500"></span>
                  <span class="text-sm text-slate-700">Fire hazard zones</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div id="tab-browse" class="tab-panel hidden p-4">
          <p class="text-sm text-slate-500">Query options would appear here.</p>
        </div>
        
        <div id="tab-export" class="tab-panel hidden p-4">
          <p class="text-sm text-slate-500">Export options would appear here.</p>
        </div>
        
      </div>
    </aside>
    
  </div>
  
  <!-- ArcGIS + App Logic -->
  <script>
    // =========================================================================
    // STATE
    // =========================================================================
    const state = {
      selectedLayer: 'earthquake-faults',
      pinnedLayers: new Set(['earthquake-faults', 'inaturalist', 'fire-hazard']),
      visibleNonPinnedLayer: null, // Only ONE non-pinned layer can be visible
      hiddenPinnedLayers: new Set(), // Pinned layers that are temporarily hidden
      expandedCategories: new Set(['geology', 'species', 'fire']),
      widgetExpanded: true
    };
    
    // Layer metadata for the widget
    const layerMeta = {
      'earthquake-faults': { name: 'Earthquake Faults', color: 'bg-purple-500', shape: 'w-3 h-0.5' },
      'inaturalist': { name: 'iNaturalist Observations', color: 'bg-green-500', shape: 'w-3 h-3 rounded-full' },
      'fire-hazard': { name: 'Fire Hazard Severity Zones', color: 'bg-orange-500', shape: 'w-3 h-3 rounded-sm' },
      'soil-types': { name: 'Soil Types', color: 'bg-amber-600', shape: 'w-3 h-3 rounded-sm' },
      'geologic-units': { name: 'Geologic Units', color: 'bg-stone-500', shape: 'w-3 h-3 rounded-sm' },
      'ebird': { name: 'eBird Sightings', color: 'bg-yellow-500', shape: 'w-3 h-3 rounded-full' },
      'calflora': { name: 'CalFlora Plants', color: 'bg-lime-500', shape: 'w-3 h-3 rounded-full' },
      'fire-threat': { name: 'Fire Threat Assessment', color: 'bg-red-500', shape: 'w-3 h-3 rounded-sm' },
      'fire-perimeters': { name: 'Historic Fire Perimeters', color: 'bg-rose-400', shape: 'w-3 h-3 rounded-sm' },
    };
    
    let mapLayers = {};
    let mapView = null;
    
    // =========================================================================
    // MAP INITIALIZATION
    // =========================================================================
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer"
    ], function(Map, MapView, FeatureLayer) {
      
      const map = new Map({ basemap: "topo-vector" });
      
      mapView = new MapView({
        container: "viewDiv",
        map: map,
        center: [-120.4275, 34.4925],
        zoom: 12,
        ui: { components: [] }
      });
      
      const fireHazardLayer = new FeatureLayer({
        url: "https://services.arcgis.com/F7DSX1DSNSiWmOqh/arcgis/rest/services/CalFire_Fire_Hazard_Severity_Zones_2023/FeatureServer/0",
        id: "fire-hazard",
        opacity: 0.7,
        visible: true
      });
      
      const inatLayer = new FeatureLayer({
        url: "https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/iNat_PreUC_View/FeatureServer/0",
        id: "inaturalist",
        visible: true,
        renderer: {
          type: "simple",
          symbol: { type: "simple-marker", size: 6, color: [34, 197, 94, 0.8], outline: { color: [255,255,255,0.8], width: 1 } }
        }
      });
      
      const earthquakeFaultsLayer = new FeatureLayer({
        url: "https://services2.arcgis.com/FiaPA4ga0iQKduv3/arcgis/rest/services/Earthquake_Faults_and_Folds_in_the_USA/FeatureServer/0",
        id: "earthquake-faults",
        visible: true,
        renderer: {
          type: "simple",
          symbol: { type: "simple-line", color: [168, 85, 247, 1], width: 2, style: "solid" }
        }
      });
      
      map.addMany([fireHazardLayer, inatLayer, earthquakeFaultsLayer]);
      
      mapLayers = {
        'fire-hazard': fireHazardLayer,
        'inaturalist': inatLayer,
        'earthquake-faults': earthquakeFaultsLayer
      };
      
      mapView.when(() => {
        document.getElementById('loading-overlay').style.display = 'none';
      });
    });
    
    // =========================================================================
    // VISIBILITY TOGGLE (for left sidebar)
    // =========================================================================
    function toggleVisibility(layerId) {
      const isPinned = state.pinnedLayers.has(layerId);
      
      if (isPinned) {
        // Pinned layer: just toggle its visibility on/off
        if (state.hiddenPinnedLayers.has(layerId)) {
          state.hiddenPinnedLayers.delete(layerId);
          if (mapLayers[layerId]) mapLayers[layerId].visible = true;
        } else {
          state.hiddenPinnedLayers.add(layerId);
          if (mapLayers[layerId]) mapLayers[layerId].visible = false;
        }
      } else {
        // Non-pinned layer: only ONE can be visible at a time
        if (state.visibleNonPinnedLayer === layerId) {
          // Turn it off
          state.visibleNonPinnedLayer = null;
          if (mapLayers[layerId]) mapLayers[layerId].visible = false;
        } else {
          // Turn off the previous visible non-pinned layer
          if (state.visibleNonPinnedLayer && mapLayers[state.visibleNonPinnedLayer]) {
            mapLayers[state.visibleNonPinnedLayer].visible = false;
          }
          // Turn on this one
          state.visibleNonPinnedLayer = layerId;
          if (mapLayers[layerId]) mapLayers[layerId].visible = true;
        }
      }
      
      updateAllUI();
    }
    
    // =========================================================================
    // PIN/UNPIN
    // =========================================================================
    function togglePin(layerId) {
      if (state.pinnedLayers.has(layerId)) {
        unpinLayer(layerId);
      } else {
        pinLayer(layerId);
      }
    }
    
    function pinLayer(layerId) {
      state.pinnedLayers.add(layerId);
      
      // If this was the visible non-pinned layer, clear that
      if (state.visibleNonPinnedLayer === layerId) {
        state.visibleNonPinnedLayer = null;
      }
      
      // Make sure it's visible on the map
      if (mapLayers[layerId]) mapLayers[layerId].visible = true;
      state.hiddenPinnedLayers.delete(layerId);
      
      updateAllUI();
    }
    
    function unpinLayer(layerId) {
      state.pinnedLayers.delete(layerId);
      state.hiddenPinnedLayers.delete(layerId);
      
      // Hide it on the map (since it's no longer pinned and not the visible non-pinned)
      if (mapLayers[layerId]) mapLayers[layerId].visible = false;
      
      updateAllUI();
    }
    
    // =========================================================================
    // TOGGLE MAP LAYER VISIBILITY (from widget)
    // =========================================================================
    function toggleMapLayerVisibility(layerId) {
      if (state.pinnedLayers.has(layerId)) {
        if (state.hiddenPinnedLayers.has(layerId)) {
          state.hiddenPinnedLayers.delete(layerId);
          if (mapLayers[layerId]) mapLayers[layerId].visible = true;
        } else {
          state.hiddenPinnedLayers.add(layerId);
          if (mapLayers[layerId]) mapLayers[layerId].visible = false;
        }
      }
      updateAllUI();
    }
    
    // =========================================================================
    // UPDATE ALL UI
    // =========================================================================
    function updateAllUI() {
      // Update left sidebar layer rows
      document.querySelectorAll('.layer-row[data-layer]').forEach(row => {
        const layerId = row.dataset.layer;
        const isPinned = state.pinnedLayers.has(layerId);
        const isVisible = isPinned ? !state.hiddenPinnedLayers.has(layerId) : state.visibleNonPinnedLayer === layerId;
        
        // Update classes
        row.classList.toggle('pinned', isPinned);
        row.classList.toggle('visible-only', !isPinned && isVisible);
        
        // Update eye icon (SVG)
        const eyeBtn = row.querySelector('.icon-btn:first-child');
        if (eyeBtn) {
          const eyeSvg = eyeBtn.querySelector('svg');
          if (eyeSvg) {
            if (isVisible) {
              // Filled eye (blue)
              eyeSvg.setAttribute('fill', 'currentColor');
              eyeSvg.setAttribute('stroke', 'none');
              eyeSvg.classList.remove('text-slate-400');
              eyeSvg.classList.add('text-blue-600');
              eyeSvg.innerHTML = '<path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>';
            } else {
              // Outline eye (gray)
              eyeSvg.setAttribute('fill', 'none');
              eyeSvg.setAttribute('stroke', 'currentColor');
              eyeSvg.classList.remove('text-blue-600');
              eyeSvg.classList.add('text-slate-400');
              eyeSvg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>';
            }
          }
        }
        
        // Update pin icon opacity
        const pinBtn = row.querySelector('.icon-btn:last-child');
        if (pinBtn) {
          pinBtn.classList.toggle('opacity-30', !isPinned);
          pinBtn.classList.toggle('opacity-100', isPinned);
        }
      });
      
      // Update floating widget
      updateFloatingWidget();
    }
    
    function updateFloatingWidget() {
      // Visible non-pinned section
      const visibleSection = document.getElementById('visible-section');
      const visibleSlot = document.getElementById('visible-layer-slot');
      
      if (state.visibleNonPinnedLayer) {
        visibleSection.classList.remove('hidden');
        const meta = layerMeta[state.visibleNonPinnedLayer] || { name: state.visibleNonPinnedLayer, color: 'bg-gray-500', shape: 'w-3 h-3' };
        visibleSlot.innerHTML = `
          <div class="widget-layer flex items-center gap-2 px-2 py-1.5 rounded bg-amber-50 border border-amber-200">
            <button class="icon-btn flex-shrink-0" onclick="toggleVisibility('${state.visibleNonPinnedLayer}')" title="Hide layer">
              <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
              </svg>
            </button>
            <div class="flex items-center gap-2 flex-1 min-w-0">
              <span class="${meta.shape} ${meta.color} flex-shrink-0"></span>
              <span class="text-sm text-slate-700 truncate">${meta.name}</span>
            </div>
            <button class="icon-btn text-amber-600 hover:text-blue-600 flex-shrink-0" onclick="pinLayer('${state.visibleNonPinnedLayer}')" title="Pin this layer">
              <span class="text-sm">üìå</span>
            </button>
          </div>
        `;
      } else {
        visibleSection.classList.add('hidden');
        visibleSlot.innerHTML = '';
      }
      
      // Pinned layers section
      const pinnedList = document.getElementById('pinned-layers-list');
      const pinnedCount = document.getElementById('pinned-count');
      
      pinnedCount.textContent = state.pinnedLayers.size;
      
      pinnedList.innerHTML = '';
      state.pinnedLayers.forEach(layerId => {
        const meta = layerMeta[layerId] || { name: layerId, color: 'bg-gray-500', shape: 'w-3 h-3' };
        const isHidden = state.hiddenPinnedLayers.has(layerId);
        
        const eyeIcon = isHidden ? 
          '<svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>' :
          '<svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>';
        
        pinnedList.innerHTML += `
          <div class="widget-layer flex items-center gap-2 px-2 py-1.5 rounded hover:bg-slate-50 ${isHidden ? 'opacity-50' : ''}" data-widget-layer="${layerId}">
            <button class="icon-btn flex-shrink-0" onclick="toggleMapLayerVisibility('${layerId}')" title="${isHidden ? 'Show' : 'Hide'} layer">
              ${eyeIcon}
            </button>
            <div class="flex items-center gap-2 flex-1 min-w-0">
              <span class="${meta.shape} ${meta.color} flex-shrink-0"></span>
              <span class="text-sm text-slate-700 truncate ${isHidden ? 'line-through' : ''}">${meta.name}</span>
            </div>
            <button class="icon-btn text-slate-400 hover:text-red-500 flex-shrink-0" onclick="unpinLayer('${layerId}')" title="Remove from pinned">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
        `;
      });
      
      if (state.pinnedLayers.size === 0) {
        pinnedList.innerHTML = '<p class="text-xs text-slate-400 italic px-2 py-2">No pinned layers. Click üìå on a layer to pin it.</p>';
      }
    }
    
    // =========================================================================
    // CATEGORY, LAYER SELECTION, TABS, WIDGET TOGGLE
    // =========================================================================
    function toggleCategory(categoryId) {
      const category = document.querySelector(`[data-category="${categoryId}"]`);
      if (!category) return;
      const content = category.querySelector('.category-content');
      const chevron = category.querySelector('.chevron');
      
      if (state.expandedCategories.has(categoryId)) {
        state.expandedCategories.delete(categoryId);
        content.classList.add('hidden');
        chevron.classList.remove('expanded');
      } else {
        state.expandedCategories.add(categoryId);
        content.classList.remove('hidden');
        chevron.classList.add('expanded');
      }
    }
    
    function selectLayer(layerId) {
      document.querySelectorAll('.layer-row').forEach(row => row.classList.remove('selected'));
      const row = document.querySelector(`.layer-row[data-layer="${layerId}"]`);
      if (row) row.classList.add('selected');
      state.selectedLayer = layerId;
    }
    
    function switchTab(tabId) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`.tab-btn[data-tab="${tabId}"]`)?.classList.add('active');
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
      document.getElementById(`tab-${tabId}`)?.classList.remove('hidden');
    }
    
    function toggleFloatingWidget() {
      const content = document.getElementById('widget-content');
      const chevron = document.getElementById('widget-chevron');
      state.widgetExpanded = !state.widgetExpanded;
      content.classList.toggle('hidden', !state.widgetExpanded);
      chevron.style.transform = state.widgetExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
    }
    
    // =========================================================================
    // INIT
    // =========================================================================
    document.addEventListener('DOMContentLoaded', () => {
      state.expandedCategories.forEach(categoryId => {
        const cat = document.querySelector(`[data-category="${categoryId}"]`);
        if (cat) {
          cat.querySelector('.category-content')?.classList.remove('hidden');
          cat.querySelector('.chevron')?.classList.add('expanded');
        }
      });
      updateAllUI();
    });
  </script>
  
</body>
</html>
